<!DOCTYPE html>

<html lang="th">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂ - Cloud Sync</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>

        body { 

            font-family: 'Kanit', sans-serif; 

            background-color: #f0fdf4; 

            -webkit-tap-highlight-color: transparent;

        }

        .mint-gradient { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); }

        .tab-active { background-color: white; color: #059669; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        

        .animate-pop { animation: pop 0.3s ease-out forwards; }

        @keyframes pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        

        /* Modal Overlay */

        .modal-overlay {

            position: fixed; top: 0; left: 0; width: 100%; height: 100%;

            background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100;

        }

        

        .loader-spin { animation: spin 1s linear infinite; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    </style>

</head>

<body class="pb-24">



    <!-- Loading Screen -->

    <div id="loading-screen" class="fixed inset-0 bg-emerald-50 z-[200] flex flex-col items-center justify-center text-emerald-600">

        <i data-lucide="loader-2" class="w-10 h-10 loader-spin mb-2"></i>

        <p class="font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂...</p>

    </div>



    <!-- Custom Confirm Modal -->

    <div id="confirm-modal" class="modal-overlay">

        <div class="bg-white p-6 rounded-[2rem] w-[85%] max-w-sm text-center">

            <div class="text-4xl mb-4">‚ö†Ô∏è</div>

            <h3 class="text-lg font-bold text-slate-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>

            <p class="text-sm text-slate-500 mb-6">‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å?</p>

            <div class="flex gap-3">

                <button onclick="closeModal()" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</button>

                <button id="modal-confirm-btn" class="flex-1 py-3 bg-rose-500 rounded-xl font-bold text-white">‡πÉ‡∏ä‡πà ‡∏•‡∏ö‡πÄ‡∏•‡∏¢</button>

            </div>

        </div>

    </div>



    <div class="max-w-md mx-auto px-5 py-8">

        <!-- Header -->

        <header class="flex justify-between items-center mb-8">

            <div>

                <h1 class="text-3xl font-bold text-emerald-900">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂</h1>

                <p class="text-emerald-600 text-xs font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‚òÅÔ∏è</p>

            </div>

            <button onclick="toggleForm()" class="bg-emerald-600 text-white p-3 rounded-2xl shadow-lg active:scale-90 transition-all">

                <i id="toggle-icon" data-lucide="plus"></i>

            </button>

        </header>



        <!-- Dashboard -->

        <div class="mint-gradient rounded-[2.5rem] p-7 text-white shadow-xl mb-10 relative overflow-hidden">

            <div class="relative z-10">

                <p class="text-emerald-50 text-[10px] uppercase font-bold tracking-widest opacity-80 mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>

                <h2 id="grand-total" class="text-4xl font-bold mb-6 tracking-tight">‡∏ø0.00</h2>

                <div class="grid grid-cols-2 gap-3">

                    <div class="bg-white/20 p-4 rounded-3xl border border-white/20">

                        <div class="flex items-center gap-2 mb-1">

                            <i data-lucide="wallet" class="w-3 h-3 text-emerald-100"></i>

                            <p class="text-[9px] text-emerald-50 font-bold uppercase">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</p>

                        </div>

                        <p id="total-cash" class="text-lg font-bold">‡∏ø0.00</p>

                    </div>

                    <div class="bg-white/20 p-4 rounded-3xl border border-white/20">

                        <div class="flex items-center gap-2 mb-1">

                            <i data-lucide="landmark" class="w-3 h-3 text-emerald-100"></i>

                            <p class="text-[9px] text-emerald-50 font-bold uppercase">‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</p>

                        </div>

                        <p id="total-bank" class="text-lg font-bold">‡∏ø0.00</p>

                    </div>

                </div>

            </div>

            <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>

        </div>



        <!-- Add Form -->

        <div id="tx-form-container" class="hidden animate-pop bg-white rounded-[2rem] p-6 shadow-xl border border-emerald-50 mb-8">

            <h3 class="font-bold text-emerald-900 mb-5 flex items-center gap-2">

                <i data-lucide="plus" class="w-4 h-4"></i> ‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà

            </h3>

            <form id="tx-form" class="space-y-4">

                <div class="bg-emerald-50 p-1 flex rounded-xl">

                    <button type="button" id="btn-expense" onclick="setTxType('expense')" class="flex-1 py-2 text-sm font-bold rounded-lg tab-active text-rose-500">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>

                    <button type="button" id="btn-income" onclick="setTxType('income')" class="flex-1 py-2 text-sm font-bold rounded-lg text-slate-400">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>

                </div>

                <div class="grid grid-cols-2 gap-2">

                    <button type="button" id="btn-cash" onclick="setTxMethod('cash')" class="py-2.5 text-xs font-bold rounded-xl border-2 border-emerald-500 bg-emerald-50 text-emerald-700">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>

                    <button type="button" id="btn-bank" onclick="setTxMethod('bank')" class="py-2.5 text-xs font-bold rounded-xl border-2 border-transparent bg-slate-50 text-slate-400">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>

                </div>

                <div class="space-y-3">

                    <input type="date" id="in-date" required class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl outline-none">

                    <input type="text" id="in-desc" placeholder="‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?" required class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl outline-none">

                    <input type="number" id="in-amount" step="0.01" placeholder="0.00" required class="w-full px-4 py-3 bg-slate-50 border border-slate-100 rounded-xl outline-none font-bold text-lg">

                </div>

                <div class="flex gap-2 pt-2">

                    <button type="button" onclick="toggleForm()" class="flex-1 font-bold text-emerald-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>

                    <button type="submit" class="flex-[2] py-4 bg-emerald-600 text-white font-bold rounded-2xl shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</button>

                </div>

            </form>

        </div>



        <!-- History List -->

        <div id="history-list" class="space-y-8"></div>



        <div id="empty-state" class="hidden text-center py-20 opacity-20">

            <div class="text-6xl mb-4">üçÉ</div>

            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏∞‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂</p>

        </div>

    </div>



    <!-- Toast Notification -->

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-emerald-900 text-white px-8 py-3 rounded-full text-sm shadow-2xl opacity-0 transition-opacity pointer-events-none z-[100]">

        ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!

    </div>



    <!-- Firebase SDKs -->

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";



        // Global Variables

        const firebaseConfig = JSON.parse(__firebase_config);

        const app = initializeApp(firebaseConfig);

        const auth = getAuth(app);

        const db = getFirestore(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'icezu-wallet-pro';

        

        let currentUser = null;

        let curType = 'expense';

        let curMethod = 'cash';

        let pendingDeleteId = null;



        // Initialize Icons

        lucide.createIcons();



        // 1. Authentication

        const initAuth = async () => {

            try {

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {

                    await signInWithCustomToken(auth, __initial_auth_token);

                } else {

                    await signInAnonymously(auth);

                }

            } catch (error) {

                console.error("Auth error:", error);

                document.getElementById('loading-screen').innerHTML = "<p class='text-rose-500 p-10 text-center'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</p>";

            }

        };



        onAuthStateChanged(auth, (user) => {

            currentUser = user;

            if (user) {

                startDataListener(user.uid);

            }

        });



        initAuth();



        // 2. Data Listener

        function startDataListener(uid) {

            const colRef = collection(db, 'artifacts', appId, 'users', uid, 'transactions');

            

            onSnapshot(colRef, (snapshot) => {

                const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                render(transactions);

                document.getElementById('loading-screen').style.display = 'none';

            }, (err) => {

                console.error("Firestore error:", err);

                document.getElementById('loading-screen').style.display = 'none';

            });

        }



        // 3. Render Logic

        function render(items) {

            const list = document.getElementById('history-list');

            const empty = document.getElementById('empty-state');

            

            if (items.length === 0) {

                list.innerHTML = '';

                empty.classList.remove('hidden');

                updateDash(0, 0, 0);

                return;

            }

            empty.classList.add('hidden');



            // Sort desc

            items.sort((a, b) => new Date(b.date) - new Date(a.date));



            // Grouping

            const groups = items.reduce((acc, i) => {

                const date = new Date(i.date);

                const mKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                if (!acc[mKey]) acc[mKey] = { list: [], in: 0, ex: 0 };

                acc[mKey].list.push(i);

                if (i.type === 'income') acc[mKey].in += parseFloat(i.amount);

                else acc[mKey].ex += parseFloat(i.amount);

                return acc;

            }, {});



            let html = '';

            let tCash = 0, tBank = 0;



            Object.keys(groups).sort().reverse().forEach(mk => {

                const g = groups[mk];

                const [y, m] = mk.split('-');

                const mLabel = new Date(y, m-1).toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });



                html += `

                    <div class="month-block">

                        <div class="flex justify-between items-end border-b-2 border-emerald-100 pb-2 mb-4">

                            <h3 class="font-bold text-emerald-900">${mLabel}</h3>

                            <div class="text-[10px] text-right font-bold uppercase">

                                <span class="text-emerald-500">‡∏£‡∏±‡∏ö ‡∏ø${g.in.toLocaleString()}</span>

                                <span class="mx-1 text-emerald-200">/</span>

                                <span class="text-rose-400">‡∏à‡πà‡∏≤‡∏¢ ‡∏ø${g.ex.toLocaleString()}</span>

                            </div>

                        </div>

                        <div class="space-y-3">

                `;



                g.list.forEach(item => {

                    const isInc = item.type === 'income';

                    html += `

                        <div class="bg-white p-3 rounded-[1.5rem] flex items-center justify-between shadow-sm border border-emerald-50 animate-pop">

                            <div class="flex items-center gap-3 overflow-hidden flex-1">

                                <div class="w-10 h-10 min-w-[40px] rounded-2xl flex items-center justify-center text-xl ${isInc ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}">

                                    <i data-lucide="${item.method === 'cash' ? 'wallet' : 'landmark'}" class="w-5 h-5"></i>

                                </div>

                                <div class="overflow-hidden">

                                    <p class="text-sm font-semibold text-slate-700 leading-tight truncate">${item.description}</p>

                                    <p class="text-[9px] text-emerald-400 font-bold uppercase">${new Date(item.date).toLocaleDateString('th-TH', {day:'numeric', month:'short'})} ‚Ä¢ ${item.method === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : '‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'}</p>

                                </div>

                            </div>

                            <div class="flex items-center gap-3 pl-2">

                                <span class="font-bold text-sm whitespace-nowrap ${isInc ? 'text-emerald-500' : 'text-rose-500'}">

                                    ${isInc ? '+' : '-'}${parseFloat(item.amount).toLocaleString()}

                                </span>

                                <button onclick="window.askDelete('${item.id}')" class="w-10 h-10 flex items-center justify-center bg-rose-50 text-rose-400 rounded-xl hover:bg-rose-500 hover:text-white transition-all active:scale-90">

                                    <i data-lucide="trash-2" class="w-4 h-4"></i>

                                </button>

                            </div>

                        </div>

                    `;

                });

                html += `</div></div>`;

            });



            // Calc Dashboard

            items.forEach(i => {

                const a = parseFloat(i.amount);

                const m = i.type === 'income' ? 1 : -1;

                if (i.method === 'cash') tCash += (a*m); else tBank += (a*m);

            });



            list.innerHTML = html;

            updateDash(tCash, tBank, tCash+tBank);

            lucide.createIcons();

        }



        function updateDash(c, b, t) {

            document.getElementById('grand-total').innerText = `‡∏ø${t.toLocaleString(undefined, {minimumFractionDigits:2})}`;

            document.getElementById('total-cash').innerText = `‡∏ø${c.toLocaleString()}`;

            document.getElementById('total-bank').innerText = `‡∏ø${b.toLocaleString()}`;

        }



        // Global functions for HTML

        window.toggleForm = () => {

            const container = document.getElementById('tx-form-container');

            const icon = document.getElementById('toggle-icon');

            container.classList.toggle('hidden');

            const isHidden = container.classList.contains('hidden');

            icon.setAttribute('data-lucide', isHidden ? 'plus' : 'x');

            lucide.createIcons();

        };



        window.setTxType = (t) => {

            curType = t;

            document.getElementById('btn-expense').className = t === 'expense' ? "flex-1 py-2 text-sm font-bold rounded-lg tab-active text-rose-500" : "flex-1 py-2 text-sm font-bold rounded-lg text-slate-400";

            document.getElementById('btn-income').className = t === 'income' ? "flex-1 py-2 text-sm font-bold rounded-lg tab-active text-emerald-600" : "flex-1 py-2 text-sm font-bold rounded-lg text-slate-400";

        };



        window.setTxMethod = (m) => {

            curMethod = m;

            document.getElementById('btn-cash').className = m === 'cash' ? "py-2.5 text-xs font-bold rounded-xl border-2 border-emerald-500 bg-emerald-50 text-emerald-700" : "py-2.5 text-xs font-bold rounded-xl border-2 border-transparent bg-slate-50 text-slate-400";

            document.getElementById('btn-bank').className = m === 'bank' ? "py-2.5 text-xs font-bold rounded-xl border-2 border-emerald-500 bg-emerald-50 text-emerald-700" : "py-2.5 text-xs font-bold rounded-xl border-2 border-transparent bg-slate-50 text-slate-400";

        };



        window.askDelete = (id) => {

            pendingDeleteId = id;

            document.getElementById('confirm-modal').style.display = 'flex';

        };



        window.closeModal = () => {

            document.getElementById('confirm-modal').style.display = 'none';

            pendingDeleteId = null;

        };



        document.getElementById('modal-confirm-btn').onclick = async () => {

            if (pendingDeleteId && currentUser) {

                try {

                    const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', pendingDeleteId);

                    await deleteDoc(docRef);

                    closeModal();

                    showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');

                } catch (e) {

                    alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

                }

            }

        };



        function showToast(m) {

            const t = document.getElementById('toast');

            t.innerText = m;

            t.classList.replace('opacity-0', 'opacity-100');

            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2500);

        }



        // Form Submit

        document.getElementById('tx-form').onsubmit = async (e) => {

            e.preventDefault();

            if (!currentUser) return;



            const descInput = document.getElementById('in-desc');

            const amtInput = document.getElementById('in-amount');

            const dateInput = document.getElementById('in-date');



            try {

                const colRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions');

                await addDoc(colRef, {

                    description: descInput.value,

                    amount: parseFloat(amtInput.value),

                    date: dateInput.value,

                    type: curType,

                    method: curMethod,

                    createdAt: new Date().toISOString()

                });

                

                descInput.value = '';

                amtInput.value = '';

                window.toggleForm();

                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

            } catch (err) {

                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

            }

        };



        document.getElementById('in-date').valueAsDate = new Date();

    </script>

</body>

</html>
