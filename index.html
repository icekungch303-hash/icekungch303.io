<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂ - Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0fdf4; -webkit-tap-highlight-color: transparent; }
        .mint-gradient { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); }
        .tab-active { background-color: white; color: #059669; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .animate-pop { animation: pop 0.3s ease-out forwards; }
        @keyframes pop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .loader-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-20">

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏´‡∏ô‡πâ‡∏≤ Loading (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Error) -->
    <div id="loading-overlay" class="fixed inset-0 bg-emerald-50 z-[200] flex flex-col items-center justify-center text-emerald-600 px-6 text-center">
        <div id="loading-spinner" class="mb-4 bg-white p-4 rounded-full shadow-lg">
            <i data-lucide="loader-2" class="w-10 h-10 loader-spin text-emerald-500"></i>
        </div>
        <p id="loading-title" class="font-bold text-lg mb-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå...</p>
        <p id="loading-status" class="text-xs text-emerald-400 opacity-70">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        
        <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î Error -->
        <div id="error-help" class="hidden mt-6 p-4 bg-white rounded-2xl shadow-sm border border-rose-100 text-rose-500 text-sm">
            <p class="font-bold mb-2">‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤!</p>
            <p class="mb-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firebase Console ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô <b>Anonymous Sign-in</b> ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π Authentication > Sign-in method</p>
            <button onclick="window.location.reload()" class="mt-2 text-xs underline">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>

        <button id="skip-loading" onclick="closeLoading()" class="hidden mt-8 text-[10px] underline text-emerald-300">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏≠‡πÄ‡∏ô‡πá‡∏ï</button>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö -->
    <div id="delete-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[150] px-6 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[2.5rem] w-full max-w-sm text-center shadow-2xl animate-pop">
            <div class="bg-rose-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500 text-3xl">üóëÔ∏è</div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</h3>
            <p class="text-sm text-slate-500 mb-8">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ô‡∏∞‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-4 bg-slate-100 rounded-2xl font-bold text-slate-400 active:scale-95 transition-all">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-delete-btn" class="flex-[1.5] py-4 bg-rose-500 text-white rounded-2xl font-bold shadow-lg shadow-rose-100 active:scale-95 transition-all">‡πÉ‡∏ä‡πà ‡∏•‡∏ö‡πÄ‡∏•‡∏¢</button>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto px-5 py-8">
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-emerald-900">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂</h1>
                <div class="flex items-center gap-1.5 mt-1">
                    <div id="conn-status-dot" class="w-2 h-2 bg-slate-300 rounded-full"></div>
                    <p id="conn-status-text" class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Connecting...</p>
                </div>
            </div>
            <button onclick="toggleForm()" class="bg-emerald-600 text-white p-3.5 rounded-2xl shadow-xl shadow-emerald-100 active:scale-90 transition-all">
                <i id="plus-icon" data-lucide="plus"></i>
            </button>
        </header>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î -->
        <div class="mint-gradient rounded-[2.5rem] p-8 text-white shadow-2xl shadow-emerald-200 mb-10 relative overflow-hidden">
            <div class="relative z-10">
                <p class="text-emerald-50 text-[10px] uppercase font-bold tracking-widest opacity-80 mb-2">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                <h2 id="grand-total" class="text-4xl font-extrabold mb-8 tracking-tighter">‡∏ø0.00</h2>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/20 backdrop-blur-md p-4 rounded-[1.8rem] border border-white/20 shadow-inner">
                        <p class="text-[9px] text-emerald-50 font-bold uppercase mb-1">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</p>
                        <p id="total-cash" class="text-lg font-bold">‡∏ø0.00</p>
                    </div>
                    <div class="bg-white/20 backdrop-blur-md p-4 rounded-[1.8rem] border border-white/20 shadow-inner">
                        <p class="text-[9px] text-emerald-50 font-bold uppercase mb-1">üè¶ ‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</p>
                        <p id="total-bank" class="text-lg font-bold">‡∏ø0.00</p>
                    </div>
                </div>
            </div>
            <div class="absolute -top-10 -right-10 w-48 h-48 bg-white/10 rounded-full blur-3xl"></div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ) -->
        <div id="add-form-container" class="hidden animate-pop bg-white rounded-[2.2rem] p-6 shadow-2xl border border-emerald-50 mb-10">
            <h3 class="font-bold text-emerald-900 mb-6 flex items-center gap-2">‚ú® ‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</h3>
            <form id="finance-form" class="space-y-4">
                <div class="bg-emerald-50 p-1.5 flex rounded-2xl">
                    <button type="button" id="type-exp" onclick="setTxType('expense')" class="flex-1 py-2.5 text-sm font-bold rounded-xl transition-all tab-active text-rose-500">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
                    <button type="button" id="type-inc" onclick="setTxType('income')" class="flex-1 py-2.5 text-sm font-bold rounded-xl transition-all text-slate-400">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button type="button" id="meth-cash" onclick="setMethod('cash')" class="py-3 text-xs font-bold rounded-xl border-2 border-emerald-500 bg-emerald-50 text-emerald-700">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
                    <button type="button" id="meth-bank" onclick="setMethod('bank')" class="py-3 text-xs font-bold rounded-xl border-2 border-transparent bg-slate-50 text-slate-400">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>
                </div>
                <div class="space-y-3">
                    <input type="date" id="input-date" required class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-400 transition-all font-medium">
                    <input type="text" id="input-desc" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏ä‡πâ‡∏≤" required class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-400 transition-all font-medium">
                    <input type="number" id="input-amount" step="0.01" placeholder="0.00" required class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-400 transition-all font-bold text-xl">
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="button" onclick="toggleForm()" class="flex-1 font-bold text-emerald-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="flex-[2] py-4 bg-emerald-600 text-white font-bold rounded-2xl shadow-lg shadow-emerald-50 active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</button>
                </div>
            </form>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 6: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
        <div id="history-content" class="space-y-10"></div>
        <div id="empty-view" class="hidden text-center py-20 opacity-20"><div class="text-7xl mb-4">üåø</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏∞‡πÑ‡∏≠‡∏ã‡πå‡∏ã‡∏∂</p></div>
    </div>

    <!-- Toast Success -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-emerald-900 text-white px-8 py-3.5 rounded-full text-sm shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[200]">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAzRDapQ3WGvB-38WiQ94A5Nh5y3HE5sJY",
            authDomain: "tungice-846ce.firebaseapp.com",
            projectId: "tungice-846ce",
            storageBucket: "tungice-846ce.firebasestorage.app",
            messagingSenderId: "818924098196",
            appId: "1:818924098196:web:5a691e754105ed14cdda81"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'icezu-wallet-vFinal';
        
        let currentUser = null;
        let curType = 'expense';
        let curMethod = 'cash';
        let deleteId = null;

        lucide.createIcons();

        // 2. ‡∏£‡∏∞‡∏ö‡∏ö Login ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error)
        const setupApp = async () => {
            setTimeout(() => {
                const btn = document.getElementById('skip-loading');
                if (btn) btn.classList.remove('hidden');
            }, 7000);

            try {
                // RULE 3: Auth Before Queries
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error", err);
                if (err.code === 'auth/configuration-not-found') {
                    document.getElementById('loading-title').innerText = "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                    document.getElementById('loading-status').innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô Firebase Console";
                    document.getElementById('error-help').classList.remove('hidden');
                    document.getElementById('loading-spinner').classList.add('hidden');
                } else {
                    closeLoading();
                }
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('conn-status-dot').className = "w-2 h-2 bg-emerald-400 rounded-full animate-pulse";
                document.getElementById('conn-status-text').innerText = "Cloud Connected";
                document.getElementById('conn-status-text').className = "text-emerald-600 text-[10px] font-bold uppercase tracking-wider";
                listenToData(user.uid);
            }
        });

        // 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Real-time
        function listenToData(uid) {
            const path = collection(db, 'artifacts', appId, 'users', uid, 'transactions');
            onSnapshot(path, (snapshot) => {
                const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                render(data);
                closeLoading();
            }, (err) => {
                console.error("Database Error", err);
                closeLoading();
            });
        }

        // 4. ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function render(items) {
            const container = document.getElementById('history-content');
            const empty = document.getElementById('empty-view');
            
            if (items.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                updateDashboard(0, 0, 0);
                return;
            }
            empty.classList.add('hidden');

            const grouped = items.reduce((acc, i) => {
                const d = new Date(i.date);
                const mKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                if (!acc[mKey]) acc[mKey] = { list: [], in: 0, ex: 0 };
                acc[mKey].list.push(i);
                if (i.type === 'income') acc[mKey].in += parseFloat(i.amount); 
                else acc[mKey].ex += parseFloat(i.amount);
                return acc;
            }, {});

            let html = '';
            let tCash = 0, tBank = 0;

            Object.keys(grouped).sort().reverse().forEach(mk => {
                const g = grouped[mk];
                const [y, m] = mk.split('-');
                const mLabel = new Date(y, m-1).toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });

                html += `
                    <div class="month-block animate-pop">
                        <div class="flex justify-between items-end border-b-2 border-emerald-100 pb-3 mb-5 px-1">
                            <h3 class="font-bold text-emerald-900">${mLabel}</h3>
                            <div class="text-[10px] text-right font-bold uppercase leading-tight">
                                <span class="text-emerald-500">‡∏ö‡∏ß‡∏Å ‡∏ø${g.in.toLocaleString()}</span><br>
                                <span class="text-rose-400">‡∏•‡∏ö ‡∏ø${g.ex.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="space-y-4">
                `;

                g.list.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(item => {
                    const isInc = item.type === 'income';
                    html += `
                        <div class="bg-white p-4 rounded-[1.8rem] flex items-center justify-between shadow-sm border border-emerald-50">
                            <div class="flex items-center gap-4 flex-1 min-w-0">
                                <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl ${isInc ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'} flex-shrink-0">
                                    <i data-lucide="${item.method === 'cash' ? 'wallet' : 'landmark'}" class="w-5 h-5"></i>
                                </div>
                                <div class="truncate">
                                    <p class="text-sm font-semibold text-slate-700 leading-tight truncate">${item.description}</p>
                                    <p class="text-[9px] text-emerald-400 font-bold uppercase tracking-widest mt-1">${new Date(item.date).toLocaleDateString('th-TH', {day:'numeric', month:'short'})} ‚Ä¢ ${item.method === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 ml-2">
                                <span class="font-bold text-sm ${isInc ? 'text-emerald-500' : 'text-rose-500'}">
                                    ${isInc ? '+' : '-'}${parseFloat(item.amount).toLocaleString()}
                                </span>
                                <button onclick="window.triggerDelete('${item.id}')" class="w-10 h-10 flex items-center justify-center bg-slate-50 text-slate-300 rounded-xl hover:bg-rose-500 hover:text-white transition-all active:scale-90">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            });

            items.forEach(i => {
                const a = parseFloat(i.amount);
                const m = i.type === 'income' ? 1 : -1;
                if (i.method === 'cash') tCash += (a*m); else tBank += (a*m);
            });

            container.innerHTML = html;
            updateDashboard(tCash, tBank, tCash+tBank);
            lucide.createIcons();
        }

        // 5. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        document.getElementById('finance-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
                return;
            }
            const desc = document.getElementById('input-desc');
            const amt = document.getElementById('input-amount');
            const date = document.getElementById('input-date');

            try {
                const path = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions');
                await addDoc(path, {
                    description: desc.value,
                    amount: parseFloat(amt.value),
                    date: date.value,
                    type: curType,
                    method: curMethod,
                    createdAt: new Date().toISOString()
                });
                desc.value = ''; amt.value = '';
                window.toggleForm();
                showToast();
            } catch (err) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
        };

        // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°
        window.closeLoading = () => document.getElementById('loading-overlay').style.display = 'none';
        
        window.toggleForm = () => {
            const f = document.getElementById('add-form-container');
            const ic = document.getElementById('plus-icon');
            f.classList.toggle('hidden');
            ic.setAttribute('data-lucide', f.classList.contains('hidden') ? 'plus' : 'x');
            lucide.createIcons();
        };

        window.setTxType = (t) => {
            curType = t;
            document.getElementById('type-exp').className = t === 'expense' ? "flex-1 py-2.5 text-sm font-bold rounded-xl transition-all tab-active text-rose-500" : "flex-1 py-2.5 text-sm font-bold rounded-xl transition-all text-slate-400";
            document.getElementById('type-inc').className = t === 'income' ? "flex-1 py-2.5 text-sm font-bold rounded-xl transition-all tab-active text-emerald-600" : "flex-1 py-2.5 text-sm font-bold rounded-xl transition-all text-slate-400";
        };

        window.setMethod = (m) => {
            curMethod = m;
            document.getElementById('meth-cash').className = m === 'cash' ? "py-3 text-xs font-bold rounded-xl border-2 border-emerald-500 bg-emerald-50 text-emerald-700" : "py-3 text-xs font-bold rounded-xl border-2 border-transparent bg-slate-50 text-slate-400";
            document.getElementById('meth-bank').className = m === 'bank' ? "py-3 text-xs font-bold rounded-xl border-2 border-emerald-500 bg-emerald-50 text-emerald-700" : "py-3 text-xs font-bold rounded-xl border-2 border-transparent bg-slate-50 text-slate-400";
        };

        window.triggerDelete = (id) => {
            deleteId = id;
            document.getElementById('delete-modal').style.display = 'flex';
        };

        window.closeDeleteModal = () => {
            document.getElementById('delete-modal').style.display = 'none';
            deleteId = null;
        };

        document.getElementById('confirm-delete-btn').onclick = async () => {
            if (deleteId && currentUser) {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', deleteId);
                    await deleteDoc(docRef);
                    closeDeleteModal();
                } catch (e) { alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
            }
        };

        function updateDashboard(c, b, t) {
            document.getElementById('grand-total').innerText = `‡∏ø${t.toLocaleString(undefined, {minimumFractionDigits:2})}`;
            document.getElementById('total-cash').innerText = `‡∏ø${c.toLocaleString()}`;
            document.getElementById('total-bank').innerText = `‡∏ø${b.toLocaleString()}`;
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2500);
        }

        setupApp();
        document.getElementById('input-date').valueAsDate = new Date();
    </script>
</body>
</html>
